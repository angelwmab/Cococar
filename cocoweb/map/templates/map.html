{% extends "base.html" %}

{% block head %}
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5LOxGZoOwWgCF88YUvO4GpOc1ia_oDcY&callback=initMap"
    async defer></script>
{% endblock %}

{% block content %}
    <!-- Navigation -->
    <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>
    <nav id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
            <li class="sidebar-brand">
                <a href="{% url "map:map-home" %}" onclick=$("#menu-close").click();>Cococar</a>
            </li>
            <li>
                <a href="{% url "map:map-home" %}" onclick=$("#menu-close").click();>Home</a>
            </li>
            <li>
                <a href="{% url "map:search_record" %}" onclick=$("#menu-close").click();>Search for Record</a>
            </li>
            <li>
                <a href="{% url "map:about" %}" onclick=$("#menu-close").click();>About</a>
            </li>
        </ul>
    </nav>

    <div id="map"></div>

    <script>
        // Closes the sidebar menu
        $("#menu-close").click(function(e) {
            e.preventDefault();
            $("#sidebar-wrapper").toggleClass("active");
        });
        // Opens the sidebar menu
        $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#sidebar-wrapper").toggleClass("active");
        });

        //Google Map
        var map;
        var markers = {};
        var markers_window = {};
        // id, infowindow, interval_id
        var chatroom_open = [];
        function initMap(){
            map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 24.968553, lng: 121.190186},
              zoom: 5
            });
        }

        $(document).ready(function(){
            setInterval(function(){
                if(map !== undefined){
                    getMarkers();
                }
            }, 3000);

        });

        function getMarkers(){
            $.getJSON("{% url "map:map-marker" %}",
                function(data){
                    //Create or edit markers with setting its position
                    // marker has two class, prefixed with "user" and "marker"
                    //"user": has live streaming url
                    //"marker": info window has chat room feature
                    //Update each marker's info window, while clicking on the marker
                    var m_copy = Object.keys(markers);
                    for(var e=0; e<data.length; e++){
                        (function(i){
                            var marker_id = data[i]["marker_id"];
                            var user_id = data[i]["user_id"] || "";
                            var talk = data[i]["talk"] || "";
                            // First Update Position
                            var p = new google.maps.LatLng(
                                    parseFloat(data[i]["latitude"]),
                                    parseFloat(data[i]["longitude"])
                                );
                            var mk;
                            if(marker_id in markers){
                                mk = markers[marker_id];
                                mk.setPosition(p);
                                var index = m_copy.indexOf(marker_id);
                                if (index > -1) {
                                    m_copy.splice(index, 1);
                                }
                            }
                            else{
                                mk = new google.maps.Marker({
                                    map: map,
                                    position:p
                                });
                                markers[marker_id] = mk;
                                if(marker_id.substring(0, 4) === "user"){
                                    mk.addListener('click', function(){
                                        var form = document.createElement('form');
                                        form.method = 'post';
                                        form.action = "{% url "map:video" %}";
                                        var input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = "marker_id";
                                        input.value = marker_id;
                                        form.appendChild(input);
                                        form.submit();
                                    })
                                }
                                else{
                                    mk.addListener('click', function(){
                                        if(chatroom_open[0] !== undefined && chatroom_open[0] !== marker_id){
                                            chatroom_open[1].close();
                                            clearInterval(chatroom_open[2]);
                                            chatroom_open = []
                                        }
                                        // In case, click on the same marker twice
                                        else if(chatroom_open[0] === marker_id){
                                            return false;
                                        }
                                        setTimeout(fire_chatroom(marker_id, mk), 1000);
                                    })
                                }
                            }
                            // Update marker's info window. Listen on hovering mouse over the marker.
                            if(talk !== ""){
                                var info =  '<h4>' + user_id + '</h4>'+
                                            '<div">'+
                                                '<p>'+ talk +'</p>'+
                                            '</div>';
                                var infowindow;
                                if(!(marker_id in markers_window)){
                                    infowindow = new google.maps.InfoWindow({
                                        content:info
                                    });
                                    markers_window[marker_id] = infowindow;
                                    mk.addListener('mouseover', function() {
                                        infowindow.open(map, mk);
                                    });
                                    mk.addListener('mouseout', function(){
                                        infowindow.close();
                                    });
                                }
                                else if(markers_window[marker_id].getContent() !== info){
                                    infowindow = markers_window[marker_id];
                                    infowindow.setContent(info);
                                }
                                if(infowindow !== undefined && chatroom_open[0] !== marker_id){
                                    infowindow.open(map, mk);
                                    setTimeout(function(){
                                        infowindow.close()
                                    }, 3000);
                                }
                            }
                        })(e);
                    }
                    //If a marker's id is not received after get method, then remove it
                    m_copy.forEach(function(marker_id){
                        m = markers[marker_id];
                        m.setMap(null);
                        delete markers[marker_id];
                        delete markers_window[marker_id];
                    })
                }
            );
        }

        function fire_chatroom(marker_id, mk){
            var infowindow = new google.maps.InfoWindow();
            $.post("{% url "map:chatroom" %}",
                JSON.stringify({"marker_id": marker_id}),
                function(data){
                    infowindow.setContent(data["html"]);
                    infowindow.open(map, mk);
                    // post input message when the button is clicked
                    $("div#chat-" + marker_id + " button#btn-chat").click(function(){
                        var value = $("div#chat-" + marker_id +" input:text").val();
                        $.post("{% url "map:map-marker" %}",
                            JSON.stringify({"marker_id": marker_id, "talk": value}),
                            function(){
                                $("div#chat-" + marker_id +" input").val("");
                            }
                        )
                    });
                    var last_time = data["last_time"];
                    var task = setInterval(function(){
                        $.post("{% url "map:update-chat" %}",
                            JSON.stringify({"marker_id": marker_id, "last_time": last_time}),
                            function(data){
                                if("html" in data){
                                    $("div#chat-" + marker_id +"  ul.chat").append(data["html"]);
                                    last_time = data["last_time"];
                                }
                        })
                    }, 1000);
                    chatroom_open = [marker_id, infowindow, task];
                    infowindow.addListener('closeclick', function(){
                        clearInterval(task);
                    })
                }
            )
        }


    </script>

{% endblock %}
